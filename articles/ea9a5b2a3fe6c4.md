---
---
title: "VMとロードバランサを主に使ってたインフラ系エンジニアが、AKSのネットワークに入門したら"
emoji: "🦁"
type: "tech"
topics: ["Azure", "Kubernetes", "AKS", "Network"]
published: false
---

## はじめに

こんにちわ、ACS事業部 SAT室 Engineering推進の簗田(やなだ)です。
2025年9月にエーピーコミュニケーションズに入社しました。

「サーバーのIPアドレスは`10.0.1.10`で、これに繋がるロードバランサのバックエンドプールに追加して…」

そんな風に、一つ一つのコンポーネントを意識しながら、丁寧にインフラを構築してきた方が、いざAKS(Azure Kubernetes Service)を前にした時、「PodのIPはどんどん変わる？」「`Service`っていう実体のないIP？」…そんなコンテナ特有の考え方に、少し戸惑いを感じていないでしょうか？

この記事は、そんな皆さんが、Kubernetesという新しい世界へスムーズに思考をスイッチするための “アップデートガイド” です。

この記事を読み終える頃には、あなたのインフラ知識を土台にして、AKSのネットワークが驚くほどシンプルに見えてくるはずです。

では早速 “アップデート” を始めていきましょう。

## Kubernetesのネットワークはどう違うのか？

まず、VMの世界を振り返ってみましょう。

サーバーを一台構築するとき、私たちはそれに`web-server-01`のような名前を付け、`10.0.1.10`といった固定のIPアドレスを割り当てます。このサーバーは、一度起動したら数ヶ月、あるいは数年間、同じ役割を担い続ける、比較的ライフサイクルが長い存在ですよね。私たちは、この一台一台を丁寧にメンテナンスしながら運用します。

この世界でのインフラ設定は、「固定的なIPアドレスを持つ、長寿命なサーバー」という土台の上に成り立っていました。

では、AKS/Kubernetesの世界ではどうでしょうか？

こちらでは、アプリケーションが動く最小単位は「**Pod**」です。Podは「**必要に応じて、いつでも新しく作り直される**」ことを前提として設計されています。

負荷が増えれば自動で新しいPodが生まれ（スケールアウト）、ノードに障害が起きれば別の場所でPodが瞬時に再作成されます。つまり、個々のPodは非常にライフサイクルが短く、簡単に交換可能な部品のような存在なのです。

そして、最も重要なことですが、**Podは再作成されるたびに、新しいIPアドレスが割り振られます**。

もし、VMの時と同じ感覚で「Pod `app-pod-xyz` のIPアドレス `10.244.0.5` にアクセスしよう」と考えてしまうと、そのPodが再作成された瞬間に、その設定は全くの無意味になってしまいます。

これが、まず最初に押さえておきたい大切なポイントです。

さて、ここで皆さんはきっとこう思うはずです。
「IPアドレスが固定じゃない場合は、どうやって通信を実現するんだ…？」と。

そのために必要な仕組みが、Kubernetesには用意されています。それが、次にお話しする「**Service**」なのです。

## AKSネットワークの主役たち：ServiceとIngress

PodのIPが当てにならないという課題を解決してくれるのが、「**Service**」と「**Ingress**」という2つの主役です。これらがどのように連携し、私たちの慣れ親しんだネットワークの世界と繋がっていくのかを見ていきましょう。

### Service：不変の仮想IPを持つL4ロードバランサ

*(ここにServiceのネットワーク図の画像を挿入)*

Podに直接アクセスするのではなく、代わりに「Service」という固定の窓口を使いましょう、というのがKubernetesの考え方です。

Serviceの役割を、皆さんが慣れ親しんだ世界で例えるなら、それはズバリ **「不変の仮想IP(Virtual IP)を持つ、賢いロードバランサ」** です。

Azure Load Balancerが持つ仮想IP（VIP）を思い浮かべてみてください。私たちは、バックエンドのサーバーのIPを直接指定するのではなく、ロードバランサが持つVIPにアクセスしますよね。

KubernetesのServiceは、これと全く同じ役割を果たします。

Serviceは、自身に割り当てられた不変のIPアドレス（**ClusterIP** と呼ばれます）を持ち、「どのPodにトラフィックを転送すべきか」を**ラベル（Label）**という目印を使って常に監視しています。ちなみに、このような動きを裏で支えているのが、各ノードで動作する `kube-proxy` というコンポーネントです。

VMの世界では、TerraformのようなIaCを用いたとしても、特定のIPアドレスをロードバランサのバックエンドプールに**「明示的に登録する」**という考え方でした。それに対して、Kubernetesの世界では、Serviceがラベルを元にPodを**「動的に発見する」**のです。ラベルをベースにServiceが自動で振り分け先のPodを発見してくれるのです。

### Ingress：”設計図” と ”建築家”

*(ここにIngressのネットワーク図の画像を挿入)*

Serviceを使えばPodにアクセスできるようになりましたが、実務では「URLのパスごとにリクエストを振り分けたい」という、要求が出てきたりします。これを解決するのがIngressです。

KubernetesのIngressを理解する鍵は、**Ingress** と **Ingress Controller** という2つの要素を区別することです。これは **”設計図”** と **”建築家”** の関係によく例えられます。

- **Ingress (リソース):** これは、あなたが作成するYAMLファイルであり、「`https://example.com/shop` へのアクセスは、`shop-service` に転送してほしい」といったルーティングのルールを定義した **”設計図”** にあたります。これ自体はトラフィックを処理する能力を持ちません。
- **Ingress Controller (コントローラー):** こちらが実際にリバースプロキシとして動作する **”建築家”** です。NGINXやApplication Gateway Ingress Controller (AGIC) といったソフトウェアがこれにあたります。Ingress Controllerは、クラスタ内のIngressリソース(設計図)を常に見張っており、新しい設計図が作成されると、それを自動で検知して自身のリバースプロキシ設定を動的に変更し、実際にトラフィックをルーティングします。

この「ルール(Ingress)」と「それを解釈して実行する実体(Ingress Controller)」の分離が、Kubernetesの宣言的な思想の核心なのです。

そして、この仕組みの本当の価値は、「アプリケーションの公開方法を、アプリの定義の一部として、開発者自身が宣言的に管理できる」という、開発スピードと俊敏性（Agility）の向上にあります。

従来のインフラ管理では、インフラチームが巨大な「Application Gateway」を一元管理していましたが、Kubernetesの世界では、開発者が自分たちのアプリの公開ルールを自分たちでコードとして管理できるのです。

## ネットワークモデルの選択：AKSの土台を設計する

最後に、Kubernetesクラスタ全体が、AzureのVNet（仮想ネットワーク）とどのように接続されるのか、という土台の話をしましょう。

**現在のAzure Portalでの選択肢 (2025年10月時点)**

現在PortalからAKSクラスタを作成する場合、主に以下の2つの選択肢が表示されます。

- **Azure CNI オーバーレイ:** これが新しい推奨モードです。
- **Azure CNI ノード サブネット:** こちらが**従来の「Azure CNI」**です。

`Kubenet`はAzure CLIを使えば引き続き利用可能ですが、「Azure CNI オーバーレイ」が新しい標準になりつつあります。この背景を踏まえ、各モデルの思想的な違いを理解しましょう。

### 各モデルの思想と特徴

#### 1. Azure CNI オーバーレイ (新しい推奨モデル)
- **思想:** Kubenetの「IPアドレス節約」と、Azure CNIの「高性能」を両立させる。
- **仕組み:** Podは独立したIP空間からIPを割り当てられ、VNetのIPアドレスを消費しません。しかし、通信はAzure CNIのアーキテクチャをベースにしているため高性能です。
- **選ぶ場合:** ほとんどのケースで、これが第一候補になります。

#### 2. Azure CNI ノード サブネット (従来のAzure CNI)
- **思想:** PodをVNetの**「正式なメンバー」**として扱い、VMと全く同じように通信させる。
- **メリット:**
    - **最高の接続性と性能:** NATを介さないため、Kubenetに比べて一般的にネットワーク性能が高いと言われています。Podに割り当てられたIPアドレスがVNet内で直接ルーティング可能になるため、オンプレミス環境とのVPN/ExpressRoute接続や、Podレベルでの厳密なネットワークセキュリティグループ(NSG)適用が必要な場合に最適な選択肢です。
- **注意点:**
    - Podの数だけVNetのIPアドレスを消費するため、大規模なIPアドレス空間の設計が必須です。
- **選ぶ場合:** 本番環境で、VNet内の既存リソースとの密な連携や、Podレベルでの厳密なネットワークセキュリティ制御が求められる場合。

#### (参考) Kubenet (CLIでのみ利用可能)
- **思想:** シンプルに、独立したネットワークをNAT経由で外部と接続させる。
- **選ぶ場合:** Kubernetesの基本的な動作を学習する目的など、限定的な用途で利用します。

## まとめ

最初は、「IPアドレスが動的に変わる」というコンテナの世界の常識に戸惑ったかもしれません。しかし、その問題を解決するServiceやIngressといった仕組みが、実は私たちに馴染み深い「ロードバランサ」や「リバースプロキシ」の考え方を応用したものであることを見てきました。

そして最も重要なのは、その根底にある思想のシフトです。

Kubernetesのネットワークは、単なる技術的な違いではありません。それは、インフラの管理を**「手続き的」なものから「宣言的」なものへと、そして「インフラ中心」から「アプリケーション中心」へと変化する**、パラダイムシフトなのです。

最後に、この記事の要点をまとめておきましょう。

- **PodのIPは動的:** そのため、PodのIPを直接参照する設計はしてはいけない。
- **Serviceの役割:** Podへの安定した窓口となる「仮想IP (L4ロードバランサ)」の役割を果たす。
- **Ingressの役割:** ”設計図”としてのIngressと、”建築家”としてのIngress Controllerに役割が分離されている。
- **思想の変化:** Ingressの真価は、開発者自身がアプリの公開方法を宣言できる俊敏性の向上にある。
- **土台の選択:** AKSのネットワークモデルは、IP節約と性能を両立した「Azure CNI オーバーレイ」が現在の主流。

Kubernetesのネットワークは、一見すると複雑に見えますが、その根底にある思想は非常にシンプルで合理的です。皆さんの豊富なインフラ経験は、この新しい世界を理解するための指針になります。

この記事が、皆さんの新しい一歩を踏み出すきっかけになれば、幸いです。
---
