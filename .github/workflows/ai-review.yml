# .github/workflows/ai-review.yml

name: AI Review by OpenAI

on:
  pull_request:
    types: [opened, synchronize] # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆ/æ›´æ–°ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œ

permissions:
  pull-requests: write # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã‚€ãŸã‚ã«å¿…è¦

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å·®åˆ†æ¯”è¼ƒã®ãŸã‚ã«å…¨å±¥æ­´ã‚’å–å¾—

      # 2. å¤‰æ›´ãŒã‚ã£ãŸè¡Œï¼ˆè¿½åŠ ã•ã‚ŒãŸè¡Œã®ã¿ï¼‰ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
      - name: Get added lines from diff and save to file
        run: |
          # æ¯”è¼ƒå…ƒãƒ–ãƒ©ãƒ³ãƒã®æƒ…å ±ã‚’ç¢ºå®Ÿã«å–å¾—
          git fetch origin ${{ github.base_ref }}
          # è¿½åŠ ã•ã‚ŒãŸè¡Œï¼ˆ+ã§å§‹ã¾ã‚‹è¡Œï¼‰ã ã‘ã‚’æŠ½å‡ºã—ã€å…ˆé ­ã®+ã‚’å‰Šé™¤ã—ã¦ä¿å­˜
          git diff origin/${{ github.base_ref }}...HEAD --unified=0 | grep '^+' | sed 's/^+//' | grep -v '^++' > diff.txt

      # 3. OpenAI APIã‚’å‘¼ã³å‡ºã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼ (æœ€çµ‚å®Œæˆç‰ˆ)
      - name: Call OpenAI API for Review
        id: openai_review
        run: |
          cat > prompt_template.txt << 'EOF'
          ã‚ãªãŸã¯å„ªç§€ãªæ—¥æœ¬èªãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ã™ã€‚
          ä»¥ä¸‹ã«Gitã®å·®åˆ†ã‹ã‚‰æŠ½å‡ºã—ãŸã€Œè¿½åŠ ã•ã‚ŒãŸè¡Œã€ã ã‘ã‚’æç¤ºã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸè¡Œã«ã¤ã„ã¦ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã„ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã—ã¦ãã ã•ã„ã€‚

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
          - èª¤å­—è„±å­—ã‚„æ–‡æ³•çš„ãªèª¤ã‚Š
          - ä¸è‡ªç„¶ãªæ—¥æœ¬èªã®è¡¨ç¾
          - è¡¨è¨˜ã‚†ã‚Œï¼ˆä¾‹ï¼šã€Œã§ã™ã¾ã™èª¿ã€ã¨ã€Œã ã§ã‚ã‚‹èª¿ã€ã®æ··åœ¨ãªã©ï¼‰
          - æŠ€è¡“ç”¨èªã®ä¸é©åˆ‡ãªä½¿ç”¨
          - ã‚ˆã‚Šåˆ†ã‹ã‚Šã‚„ã™ãã€ç°¡æ½”ã«ã™ã‚‹ãŸã‚ã®è¡¨ç¾ã®ææ¡ˆ

          # å‡ºåŠ›å½¢å¼
          - æŒ‡æ‘˜äº‹é …ãŒãªã„å ´åˆã¯ã€ã€Œãƒ¬ãƒ“ãƒ¥ãƒ¼ã®çµæœã€å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã€ã¨ã ã‘å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
          - æŒ‡æ‘˜äº‹é …ãŒã‚ã‚‹å ´åˆã¯ã€å…·ä½“çš„ãªä¿®æ­£æ¡ˆã‚’ç®‡æ¡æ›¸ãã§ç°¡æ½”ã«ç¤ºã—ã¦ãã ã•ã„ã€‚

          # ä»Šå›è¿½åŠ ã•ã‚ŒãŸè¡Œ
          EOF
          
          API_RESPONSE=$(jq -n \
            --arg model "gpt-4o" \
            --rawfile prompt_template prompt_template.txt \
            --rawfile diff_content diff.txt \
            '{
              "model": $model,
              "messages": [
                {
                  "role": "user",
                  "content": ($prompt_template + $diff_content)
                }
              ]
            }' | curl -s -X POST "https://api.openai.com/v1/chat/completions" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
              -d @-)

          echo "--- OpenAI API Response ---"
          echo "$API_RESPONSE"
          echo "--------------------------"

          REVIEW_COMMENT=$(echo "$API_RESPONSE" | jq -r '.choices[0].message.content')
          
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      # 4. ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’å–å¾—
            const reviewComment = "${{ steps.openai_review.outputs.comment }}";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### ğŸ¤– AIã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n\n${reviewComment}`
            });
