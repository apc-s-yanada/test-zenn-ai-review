# .github/workflows/ai-review.yml

name: AI Review by OpenAI

on:
  pull_request:
    types: [opened, synchronize] # プルリクエストが作成/更新された時に実行

permissions:
  pull-requests: write # プルリクエストにコメントを書き込むために必要

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # 1. リポジトリのコードをチェックアウト
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 変更があった行（追加された行のみ）をファイルに保存
      - name: Get added lines from diff and save to file
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD --unified=0 | grep '^+' | sed 's/^+//' | grep -v '^++' > diff.txt

      # 3. 【安全装置】差分の文字数をチェック
      - name: Check diff size
        id: check_size
        run: |
          CHAR_COUNT=$(wc -m < diff.txt)
          LIMIT=15000
          echo "Character count: $CHAR_COUNT"
          if [ "$CHAR_COUNT" -gt "$LIMIT" ]; then
            echo "is_too_large=true" >> $GITHUB_OUTPUT
          else
            echo "is_too_large=false" >> $GITHUB_OUTPUT
          fi

      # 4. (差分が小さい場合のみ) AI APIを呼び出してレビューを依頼
      - name: Call OpenAI API for Review
        id: openai_review
        if: steps.check_size.outputs.is_too_large == 'false'
        run: |
          PROMPT_TEMPLATE="ブログを以下にカテゴリから一つ選び(重複はあり)、カテゴリの基準に従って10段階評価して欲しいです。カテゴリの基準は世の中の一般的なBlogから適当に見積もってみてください
          例、カテゴリ3に属する、スコアは3点、理由はXXXX、スコアを上げるにはXXXが必要
          スコアリングの事例
          やってみた系、例えば、以下のBlogは1点。理由は誰になにを伝えたいのか明確でないため。
          https://techblog.ap-com.co.jp/entry/2025/09/09/084246
          ■全般共通評価軸
          〇加点ポイント
          　・趣旨が明確であること
          　・ペルソナが明確であること
          　・人を引き付けるキャッチーな題名であること
          　・起承転結があり読みやすいこと
          　・自分なりの独自の視点・考え・設計・手法・解釈など考察が入っていること
          〇減点ポイント
          　・タイポがある
          　・文法が間違っている
          　・引用などのAPCガイドラインが守られていない
          　・文章として読みづらい
          ■カテゴリごと評価軸
          〇カテゴリ１
          　海外(最新)の情報をインプットをもとにアウトプット：リリース速報系blog、こんな技術が出てきた系blog
          ・スコア指標：情報の希少性、先端性、ピックアップの仕方によってレベルがありそう
          〇カテゴリ２
          　インプットした情報で実際に触って試してみる、やってみた系blog
          ・スコア指標：これも組み合わせの複雑度や先進性によってレベルがありそう
          〇カテゴリ３
          　自分の経験、ノウハウ、事例などをアウトプット：事例やノウハウ紹介blogとか
          ・スコア指標：挑戦やシチュエーションの難易度でレベルがありそう
          〇カテゴリ４
          　現在の技術の発展とマーケットからマクロに未来を予想・発想する未来考察blog
          ・スコア指標：未来予想の解像度、リーゾニングがしっかりされているか、誰も思いつかないような発想が出来ているか
          〇カテゴリ５
          　論文のレベル、学会で通用する
          ・スコア指標：一般的な論文の評価の軸と同様
          〇カテゴリ６
          　未来の技術やソフトウェアそのものを開発してしまって結果をアウトプット
          ・スコア指標：出来るだけで凄いが、ちょっとした機能のレベルなのか、ソフトウェアやフレームワーク自体の構想なのかなど、社会的インパクトの大きさ
          
          # 今回追加された行
          "
          
          API_RESPONSE=$(jq -n \
            --arg model "gpt-4o" \
            --arg prompt_template "$PROMPT_TEMPLATE" \
            --rawfile diff_content diff.txt \
            '{
              "model": $model,
              "messages": [
                {
                  "role": "user",
                  "content": ($prompt_template + $diff_content)
                }
              ]
            }' | curl -s -X POST "https://api.openai.com/v1/chat/completions" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
              -d @-)
          
          echo "--- OpenAI API Response ---"
          echo "$API_RESPONSE"
          echo "--------------------------"
          
          REVIEW_COMMENT=$(echo "$API_RESPONSE" | jq -r '.choices[0].message.content')
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 5. レビュー結果、または警告メッセージをプルリクエストにコメントとして投稿 (最終版)
      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ "${{ steps.check_size.outputs.is_too_large }}" == "true" ]; then
            COMMENT_BODY="### ⚠️ AIレビューのスキップ
            今回のコミットの差分が大きすぎるため（15,000文字以上）、AIによるレビューをスキップしました。
            記事をいくつかのセクションに分け、コミットを分割して再度プッシュしてください。"
          else
            # AIレビュー結果を変数に格納 (ghコマンドのエラー対策)
            COMMENT_BODY_FROM_AI="${{ steps.openai_review.outputs.comment }}"
            COMMENT_BODY="### 🤖 AIによるレビュー結果
            $COMMENT_BODY_FROM_AI"
          fi
          
          # ghコマンドを使って安全にコメントを投稿する
          gh pr comment $PR_NUMBER --body "$COMMENT_BODY"
