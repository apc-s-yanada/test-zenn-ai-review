# .github/workflows/ai-review.yml

name: AI Review by OpenAI

on:
  pull_request:
    types: [opened, synchronize] # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆ/æ›´æ–°ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œ

permissions:
  pull-requests: write # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã‚€ãŸã‚ã«å¿…è¦

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å·®åˆ†æ¯”è¼ƒã®ãŸã‚ã«å…¨å±¥æ­´ã‚’å–å¾—

      # 2. å¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å–å¾—
      - name: Get PR diff
        id: pr_diff
        run: |
          # mainãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’å–å¾—ã—ã€ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆ
          DIFF=$(git diff origin/main...HEAD)
          echo "diff_content<<EOF" >> $GITHUB_ENV
          echo "$DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 3. OpenAI APIã‚’å‘¼ã³å‡ºã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼
      - name: Call OpenAI API for Review
        id: openai_review
        uses: actions/github-script@v7
        with:
          script: |
            // OpenAIã®APIã‚­ãƒ¼ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
            const apiKey = process.env.OPENAI_API_KEY;
            // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å–å¾—ã—ãŸå·®åˆ†å†…å®¹ã‚’å–å¾—
            const diffContent = process.env.diff_content;

            // ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹ã‚’å®šç¾©ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            const prompt = `
            ã‚ãªãŸã¯å„ªç§€ãªæ—¥æœ¬èªãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ã™ã€‚
            ä»¥ä¸‹ã®Gitã®å·®åˆ†ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€Zennã®è¨˜äº‹ã¨ã—ã¦å“è³ªã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã—ã¦ãã ã•ã„ã€‚

            # ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
            - èª¤å­—è„±å­—ã‚„æ–‡æ³•çš„ãªèª¤ã‚Š
            - ä¸è‡ªç„¶ãªæ—¥æœ¬èªã®è¡¨ç¾
            - è¡¨è¨˜ã‚†ã‚Œï¼ˆä¾‹ï¼šã€Œã§ã™ã¾ã™èª¿ã€ã¨ã€Œã ã§ã‚ã‚‹èª¿ã€ã®æ··åœ¨ãªã©ï¼‰
            - æŠ€è¡“ç”¨èªã®ä¸é©åˆ‡ãªä½¿ç”¨
            - ã‚ˆã‚Šåˆ†ã‹ã‚Šã‚„ã™ãã€ç°¡æ½”ã«ã™ã‚‹ãŸã‚ã®è¡¨ç¾ã®ææ¡ˆ

            # å‡ºåŠ›å½¢å¼
            - æŒ‡æ‘˜äº‹é …ãŒãªã„å ´åˆã¯ã€ã€Œãƒ¬ãƒ“ãƒ¥ãƒ¼ã®çµæœã€å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã€ã¨ã ã‘å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
            - æŒ‡æ‘˜äº‹é …ãŒã‚ã‚‹å ´åˆã¯ã€å…·ä½“çš„ãªä¿®æ­£æ¡ˆã‚’ç®‡æ¡æ›¸ãã§ç°¡æ½”ã«ç¤ºã—ã¦ãã ã•ã„ã€‚

            # Gitå·®åˆ†
            ${diffContent}
            `;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: 'gpt-4o', // ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«
                messages: [{ role: 'user', content: prompt }]
              })
            });

            const data = await response.json();
            const reviewComment = data.choices[0].message.content;
            
            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ãˆã‚‹ã‚ˆã†ã«çµæœã‚’outputã«ã‚»ãƒƒãƒˆ
            core.setOutput('comment', reviewComment);
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      # 4. ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’å–å¾—
            const reviewComment = "${{ steps.openai_review.outputs.comment }}";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### ğŸ¤– AIã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n\n${reviewComment}`
            });

      # 5. ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã€ã¾ãŸã¯è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ (æœ€çµ‚ç‰ˆ)
      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ "${{ steps.check_size.outputs.is_too_large }}" == "true" ]; then
            # å·®åˆ†ãŒå¤§ãã™ããŸå ´åˆã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            COMMENT_BODY="### âš ï¸ AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚¹ã‚­ãƒƒãƒ—
            ä»Šå›ã®ã‚³ãƒŸãƒƒãƒˆã®å·®åˆ†ãŒå¤§ãã™ãã‚‹ãŸã‚ï¼ˆ15,000æ–‡å­—ä»¥ä¸Šï¼‰ã€AIã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚
            è¨˜äº‹ã‚’ã„ãã¤ã‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ†ã‘ã€ã‚³ãƒŸãƒƒãƒˆã‚’åˆ†å‰²ã—ã¦å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚"
          else
            # æ­£å¸¸ãªAIãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ
            COMMENT_BODY="### ğŸ¤– AIã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ
            ${{ steps.openai_review.outputs.comment }}"
          fi
          
          # ghã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦å®‰å…¨ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹
          gh pr comment $PR_NUMBER --body "$COMMENT_BODY"
